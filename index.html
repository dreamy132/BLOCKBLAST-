<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Blast Clean</title>

<style>
:root{
--bg:#0f172a;
--grid:#1e293b;
--empty:#334155;
--cell:42px;
}

body{
margin:0;
font-family:sans-serif;
background:var(--bg);
color:white;
display:flex;
flex-direction:column;
align-items:center;
touch-action:none;
}

#ui{text-align:center;margin-top:15px}
#score{font-size:2rem;font-weight:bold}
#stats{opacity:.7;margin-top:5px}

#controls{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

button{
padding:8px 14px;
border:none;
border-radius:8px;
cursor:pointer;
}

#grid{
display:grid;
gap:4px;
background:var(--grid);
padding:8px;
border-radius:12px;
margin:20px 0;
}

.cell{
background:var(--empty);
border-radius:6px;
transition:.15s;
}

.cell.preview{opacity:.4}

#dock{
display:flex;
gap:20px;
height:120px;
align-items:center;
}

.shape{
display:grid;
gap:2px;
cursor:grab;
}

.dragging{
position:fixed;
pointer-events:none;
z-index:999;
transform:scale(1.15);
}

.hidden{visibility:hidden}

#gameover{
position:fixed;
inset:0;
background:#000c;
display:none;
flex-direction:column;
justify-content:center;
align-items:center;
}
</style>
</head>
<body>

<div id="ui">
<div id="score">0</div>
<div id="stats">
High: <span id="high">0</span> |
Best Combo: <span id="bestcombo">0</span>
</div>

<div id="controls">
<button onclick="undo()">Undo</button>
<button onclick="restart()">Restart</button>
</div>
</div>

<div id="grid"></div>
<div id="dock"></div>

<div id="gameover">
<h1>Game Over</h1>
<button onclick="restart()">Restart</button>
</div>

<script>
const SIZE=8;
const COLORS=["#38bdf8","#f472b6","#34d399","#facc15","#a78bfa"];
const SHAPES=[
[[1]],
[[1,1]],
[[1,1,1]],
[[1],[1]],
[[1,1],[1,1]],
[[1,0],[1,0],[1,1]],
[[1,1,1],[0,1,0]]
];

let grid,score,combo,bestCombo,high;
let dragEl=null,activeShape=null,undoState=null;

const gridEl=document.getElementById("grid");
const dock=document.getElementById("dock");

function resize(){
const size=Math.min(window.innerWidth/10,55);
document.documentElement.style.setProperty("--cell",size+"px");
gridEl.style.gridTemplateColumns=`repeat(8,${size}px)`;
}
window.addEventListener("resize",resize);

/* INIT */
function init(){
grid=Array(SIZE).fill().map(()=>Array(SIZE).fill(null));
score=0;combo=0;
bestCombo=localStorage.getItem("bestcombo")||0;
high=localStorage.getItem("high")||0;

document.getElementById("score").innerText=0;
document.getElementById("high").innerText=high;
document.getElementById("bestcombo").innerText=bestCombo;

gridEl.innerHTML="";
for(let i=0;i<64;i++){
const c=document.createElement("div");
c.className="cell";
c.style.width="var(--cell)";
c.style.height="var(--cell)";
gridEl.appendChild(c);
}

refillDock();
resize();
}

function restart(){
document.getElementById("gameover").style.display="none";
init();
}

/* SHAPES */
function refillDock(){
dock.innerHTML="";
for(let i=0;i<3;i++){
const map=JSON.parse(JSON.stringify(
SHAPES[Math.floor(Math.random()*SHAPES.length)]
));
const color=COLORS[Math.floor(Math.random()*COLORS.length)];
createShape({map,color});
}
}

function createShape(shape){
const el=document.createElement("div");
el.className="shape";
el.style.gridTemplateColumns=`repeat(${shape.map[0].length},20px)`;

shape.map.forEach(r=>{
r.forEach(v=>{
const c=document.createElement("div");
c.className="cell";
c.style.width="20px";
c.style.height="20px";
c.style.background=v?shape.color:"transparent";
el.appendChild(c);
});
});

el.onpointerdown=e=>startDrag(e,el,shape);
dock.appendChild(el);
}

/* DRAG SYSTEM */
function startDrag(e,el,shape){
e.preventDefault();

dragEl=el.cloneNode(true);
dragEl.classList.add("dragging");

dragEl.querySelectorAll(".cell").forEach(c=>{
c.style.width="var(--cell)";
c.style.height="var(--cell)";
});

document.body.appendChild(dragEl);
activeShape=shape;
el.classList.add("hidden");

moveDrag(e);

document.addEventListener("pointermove",moveDrag);
document.addEventListener("pointerup",ev=>stopDrag(ev,el),{once:true});
}

function moveDrag(e){
if(!dragEl) return;

dragEl.style.left=e.clientX-dragEl.offsetWidth/2+"px";
dragEl.style.top=e.clientY-dragEl.offsetHeight/2+"px";

clearPreview();
const pos=getPos(e);
if(pos && canPlace(pos.r,pos.c,activeShape))
showPreview(pos.r,pos.c,activeShape);
}

function stopDrag(e,original){
document.removeEventListener("pointermove",moveDrag);

const pos=getPos(e);

if(pos && canPlace(pos.r,pos.c,activeShape)){
undoState=JSON.parse(JSON.stringify(grid));
place(pos.r,pos.c,activeShape);
original.remove();
if(dock.children.length===0)refillDock();
checkLines();
}else{
original.classList.remove("hidden");
}

if(dragEl){dragEl.remove();dragEl=null;}
clearPreview();
checkGameOver();
}

/* GAME LOGIC */
function getPos(e){
const rect=gridEl.getBoundingClientRect();
const size=rect.width/8;
const c=Math.floor((e.clientX-rect.left)/size);
const r=Math.floor((e.clientY-rect.top)/size);
return(r>=0&&r<8&&c>=0&&c<8)?{r,c}:null;
}

function canPlace(r,c,shape){
for(let i=0;i<shape.map.length;i++)
for(let j=0;j<shape.map[0].length;j++)
if(shape.map[i][j]){
if(r+i>=8||c+j>=8||grid[r+i][c+j])return false;
}
return true;
}

function place(r,c,shape){
for(let i=0;i<shape.map.length;i++)
for(let j=0;j<shape.map[0].length;j++)
if(shape.map[i][j])
grid[r+i][c+j]=shape.color;
render();
}

function render(){
const cells=gridEl.querySelectorAll(".cell");
grid.flat().forEach((v,i)=>{
cells[i].style.background=v?v:"var(--empty)";
});
}

function showPreview(r,c,shape){
const cells=gridEl.querySelectorAll(".cell");
for(let i=0;i<shape.map.length;i++)
for(let j=0;j<shape.map[0].length;j++)
if(shape.map[i][j])
cells[(r+i)*8+(c+j)].classList.add("preview");
}

function clearPreview(){
gridEl.querySelectorAll(".cell").forEach(c=>c.classList.remove("preview"));
}

function checkLines(){
let cleared=0;
for(let i=0;i<8;i++){
if(grid[i].every(v=>v)){grid[i].fill(null);cleared++}
if(grid.every(row=>row[i])){grid.forEach(r=>r[i]=null);cleared++}
}

if(cleared){
combo++;
if(combo>bestCombo){
bestCombo=combo;
localStorage.setItem("bestcombo",bestCombo);
document.getElementById("bestcombo").innerText=bestCombo;
}
score+=cleared*100*combo;
if(score>high){
high=score;
localStorage.setItem("high",high);
document.getElementById("high").innerText=high;
}
document.getElementById("score").innerText=score;
}else combo=0;

render();
}

function checkGameOver(){
for(let shapeEl of dock.children){
let index=[...dock.children].indexOf(shapeEl);
let shape={map:SHAPES[index%SHAPES.length]};
for(let r=0;r<8;r++)
for(let c=0;c<8;c++)
if(canPlace(r,c,shape))return;
}
document.getElementById("gameover").style.display="flex";
}

function undo(){
if(!undoState) return;
grid=undoState;
undoState=null;
render();
}

init();
</script>
</body>
</html>
